"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),ExposureSite=function(){function e(){_classCallCheck(this,e);var t=this;$('[data-action="email-sub-list-remove-sub"]').on("click",function(e){e.preventDefault();var t=+$(this).attr("data-sub-id"),s=$(this).attr("data-email"),a=$(this);new ExposureConfirmModal($(this),"#confirm-remove-email-sub",{title:strip_tags("Unsubscribe "+s+"?"),description:strip_tags("Are you sure? This will unsubscribe "+s+" from all future new post emails from you."),yesLabel:"Yes, remove subscriber",noLabel:"No, nevermind"},function(){$.post("/email-subs/unsub-by-id/"+t,{_method:"delete"}),a.parent("li").fadeOut(200),Exposure.showMessage(strip_tags(s)+" has been unsubscribed.");var e=Math.ceil(+$("[data-current-subs-count]").attr("data-current-subs-count")-1,0);$('[data-label="post-subs-count"]').html(e),$('[data-label="post-subs-text"]').html("Post Subscriber"+(1==e?"":"s"))},function(){}).show();return!1}),this._loadingMore=!1,this.maxPagesBeforeShowingPaginator=3,this.enableEndlessScroll=window.$enableEndlessScroll;try{var s=+window.location.search.match(/page=(\d+)/)[1]}catch(a){var s=1}this.currentPage=s,1!=s&&(this.enableEndlessScroll=!1),this.$el=$(".member-site-wrapper,.member-results-wrapper"),this.$storiesEl=$("#stories"),this.$subscribeEl=$(".js-subscribe-to-stories"),this.$el.find('[data-action="site-open-subscribe-modal"]').on("click",function(e){e.preventDefault(),t.$subscribeEl.show()}),this.$subscribeEl.find('[data-action="unsubscribe-from-stories"]').on("click",function(e){e.preventDefault(),Exposure.loading(!0),$.get("/email-subs/unsub/"+$(this).attr("data-token")).done(function(e){$(".post-subscribe").hide(),$(".pre-subscribe").fadeIn(300),$("#subscribe-to-stories-email").val(""),Exposure.showMessage("Okay, you\u2019re now unsubscribed."),t.changeCachedSubsCountBy(-1),t.render()}).always(function(){Exposure.loading(!1)})}),this.$subscribeEl.find("#subscribe-to-stories-email").on("keypress",function(e){13==e.which&&t.$subscribeEl.find('[data-action="submit-subscribe-form"]').click()}),this.$subscribeEl.find('[data-action="submit-subscribe-form"]').on("click",function(e){e.preventDefault();var s=$(this),a=t.$subscribeEl.attr("data-username"),i=$("#subscribe-to-stories-email");return""==$.trim(i.val())?void i.focus():(s.attr("disabled",!0),Exposure.loading(!0),void $.post("/subscribe-via-email",{user:a,email:i.val(),source:i.data("source")||"profile",locale:i.data("locale"),url:window.location.toString()}).done(function(e){$('[data-action="unsubscribe-from-stories"]').attr("data-token",e.sub.unsub_key),$(".pre-subscribe").hide(),$(".post-subscribe").fadeIn(300),t.changeCachedSubsCountBy(1),t.render()}).error(function(e){var t=i.data("invalidEmailMessage");t||(t="Oops! Please make sure you\u2019ve entered a valid email."),Exposure.showMessage(t),i.addClass("has-errors").focus()}).always(function(){Exposure.loading(!1),s.removeAttr("disabled")}))}),this.$storiesEl.length&&(this.$el.on("click",'[data-action="site-toggle-story-options-menu"]',function(e){if($(e.target).is(".click-target")){e.preventDefault();var t=$(this).attr("data-id");$('[data-story-stats-menu-id="'+t+'"]').hide(),$('[data-story-options-menu-id="'+t+'"]').toggle()}}),this.$el.on("click",'[data-action="site-toggle-story-stats-menu"]',function(e){if($(e.target).is(".click-target")){e.preventDefault();var t=$(this).attr("data-id");$('[data-story-options-menu-id="'+t+'"]').hide(),$('[data-story-stats-menu-id="'+t+'"]').toggle()}}),this.$el.on("click",'[data-action="delete-story"]',function(e){e.preventDefault();var t=$(this),s={title:"Delete this story",description:"Deleting this story is permanent. Once it\u2019s gone, it\u2019s gone for good. Are you sure? There\u2019s no undo.",yesLabel:"Yes, Delete",noLabel:"No, Nevermind"},a=new ExposureConfirmModal(this,"#confirm-story-delete",s,function(){$("#exposure-loading-overlay").removeClass("hide");var e=t.attr("data-slug"),s=$('<a href="/delete-post/'+e+'" data-method="delete"></a>');$.rails.handleMethod(s)},function(){});a.show()}),this.$el.on("click",'[data-action="duplicate-story"]',function(e){e.preventDefault();var t,s=($(this).attr("data-slug"),$(this)),a={title:"Duplicate this Story?",description:"Duplicating a story creates a complete copy, including all text and photos, which will be available as a new draft. It may take up to a few minutes to copy your data and photos, please be patient. We\u2019ll take you to the new story as soon as it\u2019s ready.",yesLabel:"Yes, duplicate this Story",noLabel:"No, Nevermind"};t=new ExposureConfirmModal(this,"#confirm-story-dupe",a,function(){$("#exposure-loading-overlay").removeClass("hide"),$.post(s.attr("href")).done(function(e){var t=function s(){$.get(e.new_slug+"/dupe-status").done(function(t){window.location.replace("/"+e.new_slug+"?copy=1")}).error(function(){setTimeout(s,1e3)})};t()})},function(){}),t.show()}),this.$el.on("click",'[data-action="pin-story"]',function(e){e.preventDefault();var t="true"==$(this).attr("data-pinned"),s=$(this),a={title:(t?"Unpin":"Pin")+" this story?",description:t?"Un-pinning this story will stop it from showing up at the beginning of your stories.":"Pinning this story will make it show up first in your list. If you already have a story pinned, this story will take its place.",yesLabel:t?"Yes, Unpin":"Yes, Pin it!",noLabel:"No, Nevermind"},i=new ExposureConfirmModal(this,"#confirm-story-pin",a,function(){Exposure.showMessage("Making pinned story change...");var e=(s.attr("data-slug"),$('<a href="'+s.attr("href")+'" data-method="post"></a>'));$.rails.handleMethod(e)},function(){});i.show()}),this.$el.on("click",'[data-action="set-about-story"]',function(e){e.preventDefault();var t=("true"==$(this).attr("data-about-set"),$(this)),s={title:"Use this story as an About page",description:'Add an "About" link in your menus and hide this story from your feed. This will also replace any current selection for your About page',yesLabel:"Set as About story",noLabel:"No, Nevermind"},a=new ExposureConfirmModal(this,"#confirm-about-story",s,function(){Exposure.showMessage("Setting About Story...");var e=(t.attr("data-slug"),$('<a href="'+t.attr("href")+'" data-method="post"></a>'));$.rails.handleMethod(e)},function(){});a.show()}),$(window).scroll(debounce(function(){t.loadMoreIfAble()})),this.render())}return _createClass(e,[{key:"render",value:function(){var e=$("[data-subs-count]");if(e.length){var t=+e.attr("data-subs-count");1e3>t&&e.find(".dynamic-subs-count-label").html(t),e.attr("title",t+" "+(1==t?"person is":"people are")+" subscribed to stories from "+e.attr("data-full-name"),t)}}},{key:"changeCachedSubsCountBy",value:function(e){var t=$("[data-subs-count]");t.length&&t.attr("data-subs-count",+t.attr("data-subs-count")+e)}},{key:"getUrlParam",value:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),s=t.exec(location.search);return null===s?"":decodeURIComponent(s[1].replace(/\+/g," "))}},{key:"loadMore",value:function(){if(!this._loadingMore&&this.enableEndlessScroll){var e=this,t=this.currentPage+1;$(".loading-more-stories-indicator").fadeIn(300),this._loadingMore=!0,this.$el.find(".member-site-pagnation").hide(),$("#stories .story-card").css("visibility","visible");var s="",a=window.location.search.match(/year=(\d+)/);a&&a[1]&&(s=+a[1]);var i=this.getUrlParam("q");$.get("?page="+t+"&year="+s+"&q="+i).done(function(s){var a=$(s).find("#stories"),i=a.find(".story");if(i.length){a.attr("id","exlm_"+(new Date).getTime()),i.appendTo(e.$el.find("#stories .stories-wrapper")),e.currentPage=t,$("#stories .story-card").css("visibility","visible");var o=window.location.pathname+"?page="+e.currentPage;"undefined"!=typeof ga&&ga("send","pageview",o),"undefined"!=typeof _gs&&_gs("track",o)}else e.enableEndlessScroll=!1,e.currentPage>1&&$(".end-of-stories-indicator").fadeIn(300)}).error(function(){}).always(function(){$(".loading-more-stories-indicator").fadeOut(300),e._loadingMore=!1,$("#stories .story-card").css("visibility","visible"),window.$initializeSortable()})}}},{key:"loadMoreIfAble",value:function(){this.closeToBottomOfStories()&&this.loadMore()}},{key:"closeToBottomOfStories",value:function(){var e=this.$storiesEl.offset().top+this.$storiesEl.height(),t=$(window).scrollTop()+2500;return t>=e}}]),e}();$(window).ready(function(){window.$exposureSite=new ExposureSite}),$(document).ready(function(){function e(){$(".stories-wrapper").sortable({items:".sortable-item",handle:".reorder",update:function(e,t){reorder($(this).sortable("toArray",{attribute:"data-sortable-id"}))},tolerance:"pointer"})}"standalone"in window.navigator&&window.navigator.standalone&&($("a").on("click",function(e){e.preventDefault();var t=$(this).attr("href");void 0!=t&&"#"!=t.substr(0,1)&&void 0==$(this).attr("data-method")&&(window.location=t)}),$("body").addClass("is-ios-standalone")),window.$initializeSortable=e});